# ============================================================
# McLarens Analytics - Full Stack Development Environment
# ============================================================
# Start everything:  docker compose up --build
# Stop everything:   docker compose down
# Reset database:    docker compose down -v && docker compose up --build
#
# Service URLs:
#   Frontend:     http://localhost:3000
#   Backend API:  http://localhost:8000
#   API Docs:     http://localhost:8000/docs
#   GraphQL:      http://localhost:8000/graphql
#   Mailpit UI:   http://localhost:8025
#   PostgreSQL:   localhost:5433
#   Redis:        localhost:6379
# ============================================================

services:
  # ──────────────────────────────────────────────────────────
  # DATABASE: PostgreSQL 16
  # ──────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    container_name: maclarens-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-maclarens_analytics}
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/docker/db/init:/docker-entrypoint-initdb.d
      - ./infra/docker/db/seed:/docker-entrypoint-initdb.d/seed:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d maclarens_analytics"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - maclarens-network

  # ──────────────────────────────────────────────────────────
  # CACHE: Redis 7
  # ──────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: maclarens-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - maclarens-network

  # ──────────────────────────────────────────────────────────
  # EMAIL: Mailpit (dev email testing)
  # Web UI: http://localhost:8025
  # ──────────────────────────────────────────────────────────
  mailpit:
    image: axllent/mailpit:latest
    container_name: maclarens-mailpit
    ports:
      - "2025:1025"   # SMTP (host 2025 -> container 1025, avoids Windows reserved range)
      - "8025:8025"   # Web UI
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - maclarens-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025/api/v1/info"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ──────────────────────────────────────────────────────────
  # BACKEND: FastAPI (Python) - hot reload enabled
  # ──────────────────────────────────────────────────────────
  backend:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.dev
    container_name: maclarens-backend
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db:5432/maclarens_analytics
      REDIS_URL: redis://redis:6379
      PYTHON_ENV: development
      DEBUG: "true"
      ENVIRONMENT: development
      APP_URL: http://localhost:3000
      AUTH_MODE: ${AUTH_MODE:-dev}
      JWT_SECRET: ${JWT_SECRET:-maclarens-dev-secret-change-in-production}
      AZURE_CLIENT_ID: ${AZURE_AD_CLIENT_ID:-}
      AZURE_TENANT_ID: ${AZURE_AD_TENANT_ID:-}
      AZURE_CLIENT_SECRET: ${AZURE_AD_CLIENT_SECRET:-}
      EMAIL_ENABLED: "true"
      EMAIL_PROVIDER: mailpit
      SMTP_HOST: mailpit
      SMTP_PORT: 1025
      SMTP_USE_TLS: "false"
      SENDER_EMAIL: no-reply@maclarens.local
      CORS_ORIGINS: '["http://localhost:3000", "http://frontend:3000"]'
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailpit:
        condition: service_healthy
    volumes:
      - ./apps/api/src:/app/src
      - ./apps/api/alembic:/app/alembic
      - ./apps/api/alembic.ini:/app/alembic.ini
      - ./apps/api/seed_standalone.py:/app/seed_standalone.py
      - ./apps/api/seed_real_data.py:/app/seed_real_data.py
      - ./apps/api/seed_production.py:/app/seed_production.py
      - ./apps/api/seed_csv.py:/app/seed_csv.py
      - ./apps/api/seed_companies.py:/app/seed_companies.py
      - ./apps/api/seed_manual.py:/app/seed_manual.py
      - ./infra/docker/db/seed:/app/seed_data:ro
    networks:
      - maclarens-network
    restart: unless-stopped

  # ──────────────────────────────────────────────────────────
  # FRONTEND: Next.js 14 - hot reload enabled
  # ──────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev
    container_name: maclarens-frontend
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:8000/graphql
      BACKEND_URL: http://backend:8000
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-maclarens-dev-secret-change-in-production}
      DIRECTOR_PASSWORD: ${DIRECTOR_PASSWORD:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
      AZURE_AD_CLIENT_ID: ${AZURE_AD_CLIENT_ID:-}
      AZURE_AD_CLIENT_SECRET: ${AZURE_AD_CLIENT_SECRET:-}
      AZURE_AD_TENANT_ID: ${AZURE_AD_TENANT_ID:-}
      NEXT_PUBLIC_AUTH_MODE: ${AUTH_MODE:-dev}
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./apps/frontend/app:/app/app
      - ./apps/frontend/components:/app/components
      - ./apps/frontend/hooks:/app/hooks
      - ./apps/frontend/lib:/app/lib
      - ./apps/frontend/styles:/app/styles
      - ./apps/frontend/types:/app/types
      - ./apps/frontend/public:/app/public
      - ./apps/frontend/graphql:/app/graphql
      - ./apps/frontend/next.config.js:/app/next.config.js
      - ./apps/frontend/tsconfig.json:/app/tsconfig.json
      - ./apps/frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./apps/frontend/postcss.config.js:/app/postcss.config.js
      - frontend_node_modules:/app/node_modules
      - frontend_next:/app/.next
    networks:
      - maclarens-network
    restart: unless-stopped

# ──────────────────────────────────────────────────────────
# VOLUMES
# ──────────────────────────────────────────────────────────
volumes:
  postgres_data:
  redis_data:
  frontend_node_modules:
  frontend_next:

# ──────────────────────────────────────────────────────────
# NETWORKS
# ──────────────────────────────────────────────────────────
networks:
  maclarens-network:
    driver: bridge
