# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# McLarens Analytics â€” Deploy to Azure Container Apps
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Triggers on push to main branch.
# Builds Docker images â†’ pushes to ACR â†’ deploys to Container Apps.
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS          â€” Service principal JSON (az ad sp create-for-rbac)
#   ACR_LOGIN_SERVER           â€” e.g. mclacr.azurecr.io
#   ACR_USERNAME               â€” ACR admin username or SP client ID
#   ACR_PASSWORD               â€” ACR admin password or SP client secret
#   AZURE_RESOURCE_GROUP       â€” e.g. rg-mclarens-analytics-prod
#   AZURE_SUBSCRIPTION_ID      â€” Azure subscription ID
#
# Required GitHub Secrets (App Config):
#   JWT_SECRET                 â€” Production JWT signing secret
#   NEXTAUTH_SECRET            â€” NextAuth encryption secret
#   AZURE_AD_CLIENT_ID         â€” Entra ID App Registration client ID
#   AZURE_AD_TENANT_ID         â€” Entra ID tenant ID
#   AZURE_AD_CLIENT_SECRET     â€” Entra ID client secret
#   DATABASE_URL               â€” Managed PostgreSQL connection string
#   REDIS_URL                  â€” Managed Redis connection string
#   PRODUCTION_DOMAIN          â€” e.g. app.mclarens-analytics.com
#
# Optional GitHub Secrets (Email):
#   AZURE_EMAIL_CONNECTION_STRING â€” ACS Email connection string
#   AZURE_EMAIL_SENDER            â€” ACS verified sender
#   RESEND_API_KEY                â€” If using Resend instead
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy to Azure

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'production' }}
  cancel-in-progress: false # Never cancel in-progress production deploys

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  # Container App names
  BACKEND_APP_NAME: ca-mclarens-backend
  FRONTEND_APP_NAME: ca-mclarens-frontend

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. CI GATE â€” Run tests before deploying
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-gate:
    name: CI Gate (Tests)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/api

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: maclarens_analytics_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y libpq-dev
          pip install -r requirements.txt

      - name: Run backend tests
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/maclarens_analytics_test
          REDIS_URL: redis://localhost:6379
          AUTH_MODE: dev
          JWT_SECRET: ci-test-secret-not-for-production
          ENVIRONMENT: test
          EMAIL_ENABLED: "false"
          EMAIL_PROVIDER: disabled
        run: pytest -v --tb=short

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. BUILD & PUSH â€” Docker images to Azure Container Registry
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: ci-gate
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="${{ env.ACR_LOGIN_SERVER }}/mclarens-backend:${SHORT_SHA}-${TIMESTAMP}"
          LATEST="${{ env.ACR_LOGIN_SERVER }}/mclarens-backend:latest"
          echo "tags=${TAG}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push backend image
        run: |
          docker build \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -t ${{ steps.meta.outputs.tags }} \
            -t ${{ steps.meta.outputs.latest }} \
            -f apps/api/Dockerfile \
            ./apps/api

          docker push ${{ steps.meta.outputs.tags }}
          docker push ${{ steps.meta.outputs.latest }}

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: ci-gate
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="${{ env.ACR_LOGIN_SERVER }}/mclarens-frontend:${SHORT_SHA}-${TIMESTAMP}"
          LATEST="${{ env.ACR_LOGIN_SERVER }}/mclarens-frontend:latest"
          echo "tags=${TAG}" >> $GITHUB_OUTPUT
          echo "latest=${LATEST}" >> $GITHUB_OUTPUT

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=https://${{ secrets.PRODUCTION_DOMAIN }}/graphql \
            --build-arg NEXT_PUBLIC_AUTH_MODE=entra \
            --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            -t ${{ steps.meta.outputs.tags }} \
            -t ${{ steps.meta.outputs.latest }} \
            -f apps/frontend/Dockerfile \
            ./apps/frontend

          docker push ${{ steps.meta.outputs.tags }}
          docker push ${{ steps.meta.outputs.latest }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. DEPLOY â€” Update Azure Container Apps
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [build-backend]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://api.${{ secrets.PRODUCTION_DOMAIN }}

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy backend to Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.BACKEND_APP_NAME }}
          imageToDeploy: ${{ needs.build-backend.outputs.image-tag }}

      - name: Run database migrations
        run: |
          az containerapp exec \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --command "alembic upgrade head"

      - name: Verify backend health
        run: |
          echo "Waiting 30s for container to stabilize..."
          sleep 30

          BACKEND_FQDN=$(az containerapp show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "Backend FQDN: ${BACKEND_FQDN}"

          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://${BACKEND_FQDN}/health" --max-time 15)

          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "âŒ Backend health check failed with status: ${HEALTH_STATUS}"
            exit 1
          fi

          echo "âœ… Backend health check passed (HTTP ${HEALTH_STATUS})"

          # Full health check
          curl -s "https://${BACKEND_FQDN}/health/full" | python3 -m json.tool

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build-frontend, deploy-backend]
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ secrets.PRODUCTION_DOMAIN }}

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy frontend to Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.FRONTEND_APP_NAME }}
          imageToDeploy: ${{ needs.build-frontend.outputs.image-tag }}

      - name: Verify frontend health
        run: |
          echo "Waiting 30s for container to stabilize..."
          sleep 30

          FRONTEND_FQDN=$(az containerapp show \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "Frontend FQDN: ${FRONTEND_FQDN}"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://${FRONTEND_FQDN}" --max-time 15)

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Frontend health check failed with status: ${HTTP_STATUS}"
            exit 1
          fi

          echo "âœ… Frontend is live (HTTP ${HTTP_STATUS})"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. POST-DEPLOY â€” Smoke tests + notification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smoke-test:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run smoke tests
        run: |
          BACKEND_FQDN=$(az containerapp show \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  POST-DEPLOY SMOKE TESTS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Test 1: API root
          echo "Test 1: API Root..."
          curl -sf "https://${BACKEND_FQDN}/" | python3 -m json.tool
          echo "âœ… API root OK"

          # Test 2: Full health check
          echo ""
          echo "Test 2: Full Health..."
          HEALTH=$(curl -sf "https://${BACKEND_FQDN}/health/full")
          echo "$HEALTH" | python3 -m json.tool

          STATUS=$(echo "$HEALTH" | python3 -c "import sys, json; print(json.load(sys.stdin).get('status', 'unknown'))")
          if [ "$STATUS" != "healthy" ]; then
            echo "âš ï¸  System health is: ${STATUS} (expected: healthy)"
          else
            echo "âœ… System health: healthy"
          fi

          # Test 3: Auth endpoint availability
          echo ""
          echo "Test 3: Auth endpoint..."
          AUTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://${BACKEND_FQDN}/auth/providers" --max-time 10)
          echo "Auth endpoint returned: HTTP ${AUTH_STATUS}"

          # Test 4: Config check (non-sensitive)
          echo ""
          echo "Test 4: Config summary..."
          curl -sf "https://${BACKEND_FQDN}/health/config" | python3 -m json.tool
          echo "âœ… Config endpoint OK"

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ALL SMOKE TESTS PASSED âœ…"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Deployment summary
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${SHORT_SHA}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Backend** | \`${{ env.BACKEND_APP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Frontend** | \`${{ env.FRONTEND_APP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All smoke tests passed. âœ…" >> $GITHUB_STEP_SUMMARY
